# KAISEI システム構成ドキュメント

## 概要

このドキュメントでは、KAISEIアプリケーションのシステム構成について説明します。開発環境（Mac + Docker）と本番環境（Render + Neon）の両方の構成を詳細に記載し、各環境での技術スタックとデプロイメント戦略を明確にします。

---

## システム全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        KAISEI システム全体構成                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │      ユーザー    │
                              │    (ブラウザ)    │
                              └─────────────────┘
                                       │
                                       │ HTTPS
                                       ▼
                              ┌─────────────────┐
                              │   CDN/Edge      │
                              │   (Render)      │
                              └─────────────────┘
                                       │
                          ┌────────────┼────────────┐
                          │            │            │
                 ┌────────▼────────┐   │   ┌────────▼────────┐
                 │   開発環境       │   │   │   本番環境       │
                 │  (Mac Docker)   │   │   │  (Render)       │
                 └─────────────────┘   │   └─────────────────┘
                          │            │            │
                          ▼            ▼            ▼
                 ┌─────────────────┐   │   ┌─────────────────┐
                 │ Local Database  │   │   │ Neon Database   │
                 │  (PostgreSQL)   │   │   │  (PostgreSQL)   │
                 └─────────────────┘   │   └─────────────────┘
                                       │
                                 ┌─────▼─────┐
                                 │   開発者   │
                                 │ (ローカル) │
                                 └───────────┘
```

---

## 開発環境構成 (Mac + Docker)

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         開発環境 - Mac Docker 構成                            │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                     Mac (ホストマシン)                           │
    │                                                                 │
    │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
    │  │   VS Code       │  │     Git         │  │     Node.js     │  │
    │  │   (IDE)         │  │   (Version      │  │   (パッケージ    │  │
    │  │                 │  │    Control)     │  │     管理)       │  │
    │  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
    │                                                                 │
    │  ┌─────────────────────────────────────────────────────────────┐  │
    │  │               Docker Desktop                                │  │
    │  │                                                             │  │
    │  │  ┌─────────────────┐          ┌─────────────────┐          │  │
    │  │  │   app-dev       │          │   postgres      │          │  │
    │  │  │   Container     │◄────────►│   Container     │          │  │
    │  │  │                 │          │                 │          │  │
    │  │  │ • Next.js 14    │          │ • PostgreSQL   │          │  │
    │  │  │ • TypeScript    │          │   15+           │          │  │
    │  │  │ • Tailwind CSS  │          │ • Port: 5432    │          │  │
    │  │  │ • Prisma        │          │ • Volume Mount │          │  │
    │  │  │ • Port: 3000    │          │                 │          │  │
    │  │  │ • Hot Reload    │          │                 │          │  │
    │  │  └─────────────────┘          └─────────────────┘          │  │
    │  │           │                            │                   │  │
    │  │           └────────────────────────────┘                   │  │
    │  │                      Docker Network                        │  │
    │  └─────────────────────────────────────────────────────────────┘  │
    │                                                                 │
    │  ポートマッピング:                                               │
    │  • localhost:3000 → app-dev:3000 (アプリケーション)            │
    │  • localhost:5432 → postgres:5432 (データベース)               │
    └─────────────────────────────────────────────────────────────────┘
```

### 技術スタック詳細

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      開発環境 技術スタック                                      │
├─────────────────┬────────────────────┬───────────────────────────────────────┤
│ レイヤー         │ 技術・ツール        │ 説明                                  │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Frontend        │ Next.js 14         │ React Framework (App Router)         │
│                 │ TypeScript         │ 型安全性確保                          │
│                 │ Tailwind CSS       │ ユーティリティファーストCSS           │
│                 │ Lucide React       │ アイコンライブラリ                    │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Backend         │ Next.js API Routes │ サーバーレス API                      │
│                 │ Prisma ORM         │ データベース操作                      │
│                 │ Next Auth          │ 認証システム（将来拡張用）            │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Database        │ PostgreSQL 15+     │ リレーショナルデータベース            │
│                 │ Docker Volume      │ データ永続化                          │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Development     │ Docker Desktop     │ コンテナ化                            │
│ Tools           │ Docker Compose     │ マルチコンテナ管理                    │
│                 │ VS Code            │ IDE                                   │
│                 │ Git                │ バージョン管理                        │
│                 │ ESLint             │ コード品質チェック                    │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Build Tools     │ npm                │ パッケージ管理                        │
│                 │ PostCSS            │ CSS処理                               │
│                 │ Autoprefixer       │ ベンダープレフィックス自動付与        │
└─────────────────┴────────────────────┴───────────────────────────────────────┘
```

### Docker Compose 構成

```yaml
# docker-compose.yml の構成概要
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Docker Compose サービス                              │
└─────────────────────────────────────────────────────────────────────────────┘

services:
  ┌─────────────────┐
  │   app-dev       │
  │                 │
  │ build: .        │
  │ dockerfile:     │
  │   Dockerfile.   │
  │   dev           │
  │                 │
  │ ports:          │
  │   - 3000:3000   │
  │                 │
  │ volumes:        │
  │   - ./src:/app  │
  │     /src        │
  │   - node_modules│
  │                 │
  │ environment:    │
  │   - NODE_ENV=   │
  │     development │
  │   - DATABASE_   │
  │     URL=...     │
  └─────────────────┘
           │
           │ depends_on
           ▼
  ┌─────────────────┐
  │   postgres      │
  │                 │
  │ image:          │
  │   postgres:15   │
  │                 │
  │ ports:          │
  │   - 5432:5432   │
  │                 │
  │ volumes:        │
  │   - postgres_   │
  │     data:/var/  │
  │     lib/        │
  │     postgresql/ │
  │     data        │
  │                 │
  │ environment:    │
  │   - POSTGRES_   │
  │     DB=kaisei   │
  │   - POSTGRES_   │
  │     USER=...    │
  │   - POSTGRES_   │
  │     PASSWORD=...│
  └─────────────────┘
```

---

## 本番環境構成 (Render + Neon)

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        本番環境 - Render + Neon 構成                          │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │     ユーザー     │
                              │   (グローバル)   │
                              └─────────────────┘
                                       │
                                       │ HTTPS/HTTP2
                                       ▼
                              ┌─────────────────┐
                              │  Render Global  │
                              │   CDN Network   │
                              │                 │
                              │ • SSL/TLS       │
                              │ • Gzip圧縮      │
                              │ • キャッシュ     │
                              └─────────────────┘
                                       │
                                       │ Private Network
                                       ▼
                    ┌─────────────────────────────────────┐
                    │           Render Platform           │
                    │                                     │
                    │  ┌─────────────────┐               │
                    │  │   Web Service   │               │
                    │  │                 │               │
                    │  │ • Next.js App   │               │
                    │  │ • Auto Deploy   │               │
                    │  │ • Auto Scale    │               │
                    │  │ • Health Check  │               │
                    │  │ • Log Monitor   │               │
                    │  └─────────────────┘               │
                    │           │                         │
                    └───────────┼─────────────────────────┘
                                │
                                │ Secure Connection
                                │ (SSL/TLS)
                                ▼
                    ┌─────────────────────────────────────┐
                    │         Neon Database               │
                    │                                     │
                    │  ┌─────────────────┐               │
                    │  │  PostgreSQL     │               │
                    │  │   Serverless    │               │
                    │  │                 │               │
                    │  │ • Auto Scale    │               │
                    │  │ • Branching     │               │
                    │  │ • Point-in-time │               │
                    │  │   Recovery      │               │
                    │  │ • Connection    │               │
                    │  │   Pooling       │               │
                    │  └─────────────────┘               │
                    └─────────────────────────────────────┘
```

### デプロイメントフロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         デプロイメントフロー                                   │
└─────────────────────────────────────────────────────────────────────────────┘

1. コード変更・プッシュ
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │   開発者     │───▶│    Git      │───▶│   GitHub    │
   │             │    │   Commit    │    │ Repository  │
   └─────────────┘    └─────────────┘    └─────────────┘
                                                │
                                                │ Webhook
                                                ▼
2. 自動ビルド・デプロイ                        ┌─────────────┐
   ┌─────────────┐    ┌─────────────┐        │   Render    │
   │  Build      │───▶│   Deploy    │◄───────│  Platform   │
   │  Process    │    │   Process   │        │             │
   └─────────────┘    └─────────────┘        └─────────────┘
          │                    │
          ▼                    ▼
   ┌─────────────┐    ┌─────────────┐
   │ • npm build │    │ • Health    │
   │ • Prisma    │    │   Check     │
   │   Generate  │    │ • Service   │
   │ • Type      │    │   Start     │
   │   Check     │    │ • SSL       │
   │             │    │   Setup     │
   └─────────────┘    └─────────────┘

3. データベース接続
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │   Render    │───▶│ Connection  │───▶│    Neon     │
   │ Web Service │    │   String    │    │  Database   │
   └─────────────┘    └─────────────┘    └─────────────┘
```

### 本番環境技術スタック

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       本番環境 技術スタック                                     │
├─────────────────┬────────────────────┬───────────────────────────────────────┤
│ レイヤー         │ サービス・技術      │ 特徴・機能                            │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ CDN/Edge        │ Render Global CDN  │ • グローバル配信                      │
│                 │                    │ • 自動SSL/TLS                         │
│                 │                    │ • HTTP/2, Gzip                        │
│                 │                    │ • 静的アセットキャッシュ              │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Web Hosting     │ Render Web Service │ • Git連携自動デプロイ                 │
│                 │                    │ • 自動スケーリング                    │
│                 │                    │ • ヘルスチェック                      │
│                 │                    │ • ログ監視                            │
│                 │                    │ • 環境変数管理                        │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Application     │ Next.js 14         │ • Server-side Rendering               │
│                 │ (Production Build) │ • Static Site Generation             │
│                 │                    │ • API Routes                          │
│                 │                    │ • Image Optimization                  │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Database        │ Neon PostgreSQL    │ • サーバーレス PostgreSQL             │
│                 │                    │ • 自動スケーリング                    │
│                 │                    │ • ブランチング機能                    │
│                 │                    │ • コネクションプーリング              │
│                 │                    │ • ポイントインタイムリカバリ          │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Monitoring      │ Render Dashboard   │ • アプリケーション監視                │
│                 │ Neon Dashboard     │ • データベース監視                    │
│                 │                    │ • パフォーマンスメトリクス            │
│                 │                    │ • アラート機能                        │
└─────────────────┴────────────────────┴───────────────────────────────────────┘
```

---

## 環境間の違いと特徴

### 設定・環境変数の管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        環境変数・設定管理                                      │
└─────────────────────────────────────────────────────────────────────────────┘

開発環境 (Docker):
┌─────────────────┐
│ .env            │  ┌─────────────────────────────────────┐
│ docker-compose  │  │ DATABASE_URL=postgresql://user:pass │
│ .yml            │──│ @localhost:5432/kaisei              │
│                 │  │ NODE_ENV=development                │
│ • ローカルDB     │  │ NEXTAUTH_SECRET=dev-secret          │
│ • 開発用シークレ │  │ NEXTAUTH_URL=http://localhost:3000  │
│   ット          │  └─────────────────────────────────────┘
│ • ホットリロード │
└─────────────────┘

本番環境 (Render + Neon):
┌─────────────────┐
│ Render          │  ┌─────────────────────────────────────┐
│ Environment     │  │ DATABASE_URL=postgresql://username  │
│ Variables       │──│ :password@hostname.neon.tech/dbname │
│                 │  │ NODE_ENV=production                 │
│ • 暗号化保存     │  │ NEXTAUTH_SECRET=prod-secret-string  │
│ • 自動注入       │  │ NEXTAUTH_URL=https://kaisei.app     │
│ • セキュア管理   │  └─────────────────────────────────────┘
└─────────────────┘
```

### データベース比較

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        データベース比較                                        │
├─────────────────┬────────────────────┬───────────────────────────────────────┤
│ 項目            │ 開発環境 (Docker)   │ 本番環境 (Neon)                       │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ PostgreSQL版本  │ 15.x               │ 15.x (互換性確保)                     │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ 接続方法        │ localhost:5432     │ SSL接続 (必須)                        │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ データ永続化    │ Docker Volume      │ 自動バックアップ                      │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ スケーリング    │ 固定リソース        │ 自動スケーリング                      │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ パフォーマンス  │ ローカル高速        │ グローバル最適化                      │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ 監視・ログ      │ Docker logs        │ Neon Dashboard                        │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ バックアップ    │ 手動               │ 自動 (PITR対応)                       │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ コスト         │ 無料               │ 使用量ベース課金                      │
└─────────────────┴────────────────────┴───────────────────────────────────────┘
```

---

## デプロイメント戦略

### CI/CDパイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CI/CD パイプライン                                      │
└─────────────────────────────────────────────────────────────────────────────┘

      ┌─────────────────┐
      │   Developer     │
      │   Push Code     │
      └─────────────────┘
               │
               ▼
      ┌─────────────────┐
      │   GitHub        │
      │   Repository    │
      └─────────────────┘
               │
               │ Webhook
               ▼
      ┌─────────────────┐
      │   Render        │
      │   Auto Deploy   │
      └─────────────────┘
               │
               ▼
  ┌─────────────────────────────┐
  │     Build Process           │
  │                             │
  │ 1. 📦 npm install           │
  │ 2. 🔧 prisma generate       │
  │ 3. ✅ npm run lint          │
  │ 4. 🏗️  npm run build        │
  │ 5. 🧪 Type checking         │
  └─────────────────────────────┘
               │
               ▼
  ┌─────────────────────────────┐
  │    Deployment               │
  │                             │
  │ 1. 🚀 Service Start         │
  │ 2. 🔗 Database Connect      │
  │ 3. ❤️  Health Check         │
  │ 4. 🌐 SSL Certificate       │
  │ 5. 📊 Monitor Start         │
  └─────────────────────────────┘
               │
               ▼
      ┌─────────────────┐
      │   Live Service  │
      │   (Production)  │
      └─────────────────┘
```

### ロールバック戦略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ロールバック戦略                                       │
└─────────────────────────────────────────────────────────────────────────────┘

問題発生時の対応フロー:

1. 自動検知
   ┌─────────────────┐    ┌─────────────────┐
   │  Health Check   │───▶│    Alert        │
   │    Failure      │    │   Notification  │
   └─────────────────┘    └─────────────────┘

2. 手動ロールバック
   ┌─────────────────┐    ┌─────────────────┐
   │  Render         │───▶│  Previous       │
   │  Dashboard      │    │   Deployment    │
   └─────────────────┘    └─────────────────┘

3. データベースロールバック (必要時)
   ┌─────────────────┐    ┌─────────────────┐
   │  Neon Point-in- │───▶│   Database      │
   │  Time Recovery  │    │   Restore       │
   └─────────────────┘    └─────────────────┘
```

---

## セキュリティ考慮事項

### セキュリティレイヤー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         セキュリティレイヤー                                   │
└─────────────────────────────────────────────────────────────────────────────┘

1. Transport Layer Security
   ┌─────────────────────────────────────────────────────────┐
   │                    SSL/TLS                              │
   │                                                         │
   │  ┌─────────────┐      ┌─────────────┐                  │
   │  │   Browser   │◄────▶│   Render    │                  │
   │  │             │ HTTPS│   CDN       │                  │
   │  └─────────────┘      └─────────────┘                  │
   │                                                         │
   │  • TLS 1.3                                              │
   │  • 自動証明書更新                                        │
   │  • HSTS (HTTP Strict Transport Security)                │
   └─────────────────────────────────────────────────────────┘

2. Application Security
   ┌─────────────────────────────────────────────────────────┐
   │                 Next.js Security                        │
   │                                                         │
   │  • CSRF Protection                                      │
   │  • XSS Prevention                                       │
   │  • SQL Injection Prevention (Prisma ORM)               │
   │  • Environment Variables Encryption                     │
   │  • Input Validation & Sanitization                     │
   └─────────────────────────────────────────────────────────┘

3. Database Security
   ┌─────────────────────────────────────────────────────────┐
   │                  Neon Security                          │
   │                                                         │
   │  • Connection Encryption (SSL required)                │
   │  • IP Allowlisting                                      │
   │  • Role-based Access Control                           │
   │  • Audit Logging                                       │
   │  • Data Encryption at Rest                             │
   └─────────────────────────────────────────────────────────┘
```

---

## 監視・ログ管理

### 監視ダッシュボード

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        監視・ログ管理                                          │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  Render Logs    │
                              │                 │
                              │ • Access Logs   │
                              │ • Error Logs    │
                              │ • Build Logs    │
                              │ • Deploy Logs   │
                              └─────────────────┘
                                       │
                              ┌────────┼────────┐
                              │                 │
                              ▼                 ▼
                    ┌─────────────────┐ ┌─────────────────┐
                    │  Application    │ │   Database      │
                    │   Metrics       │ │    Metrics      │
                    │                 │ │                 │
                    │ • Response Time │ │ • Query Time    │
                    │ • Error Rate    │ │ • Connection    │
                    │ • Memory Usage  │ │   Pool Status   │
                    │ • CPU Usage     │ │ • Storage Usage │
                    └─────────────────┘ └─────────────────┘
                              │                 │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │     Alerts      │
                              │                 │
                              │ • Email通知     │
                              │ • Slack通知     │
                              │ • ダッシュボード │
                              └─────────────────┘
```

---

## パフォーマンス最適化

### 最適化戦略

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        パフォーマンス最適化                                     │
├─────────────────┬────────────────────┬───────────────────────────────────────┤
│ レイヤー         │ 最適化手法          │ 実装方法                              │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Frontend        │ コード分割          │ Next.js Dynamic Imports               │
│                 │ 画像最適化          │ Next.js Image Component               │
│                 │ CSS最適化          │ Tailwind CSS Purging                 │
│                 │ Bundle Size削減    │ Tree Shaking                          │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Backend         │ API最適化          │ データベースクエリ最適化              │
│                 │ キャッシュ戦略      │ Next.js Static Generation             │
│                 │ レスポンス圧縮      │ Gzip/Brotli                           │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Database        │ クエリ最適化        │ Prisma Query Optimization             │
│                 │ 接続プール          │ Neon Connection Pooling               │
│                 │ インデックス        │ 適切なインデックス設計                │
├─────────────────┼────────────────────┼───────────────────────────────────────┤
│ Infrastructure  │ CDN活用            │ Render Global CDN                     │
│                 │ 自動スケーリング    │ Render/Neon Auto Scaling              │
│                 │ 地理的分散          │ Edge Network                          │
└─────────────────┴────────────────────┴───────────────────────────────────────┘
```

---

## まとめ

KAISEIのシステム構成は、開発効率性と本番環境での可用性・スケーラビリティを両立した設計となっています。Docker環境での快適な開発体験と、Render + Neonによる堅牢で保守性の高い本番環境を提供し、小規模チームでも効率的な運用が可能な構成を実現しています。